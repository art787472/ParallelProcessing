## 平行處理資料載入/寫入速度

## 硬體設備
### CPU i5-14500HX P-Core:6 E-Core:8 Threads:20
### RAM:48G 

順便看一下最終消耗的記憶體用量
### 實驗0
#### 實驗0-1(單純讀取)：

| 筆數 | 秒數(s) | 記憶體用量(mb) |
|------|------|------------|
| 1,000 | 0.132 | 12 |
| 5,000 | 0.137 | 14 |
| 10,000 | 0.135 | 18 |
| 50,000 | 0.706 | 28 |
| 100,000 | 0.788 | 42 |
| 150,000 | 2.435 | 56 |
| 200,000 | 3.432 | 67 |
| 500,000 | 5.017 | 144 |
| 1,000,000 | 11.232 | 272 |
| 5,000,000 | 46.747 | 1100 |
| 10,000,000 | 130.46 | 646 |

#### 實驗0-2(讀取+寫入)：
| 筆數 | 秒數(s) | 記憶體用量(mb) |
|------|-----|------------|
| 1,000 | 0.058 | 12 |
| 5,000 | 0.25 | 18 |
| 10,000 | 0.666 | 20 |
| 50,000 | 1.23 | 29 |
| 100,000 | 2.426 | 44 |
| 150,000 | 2.719 | 59 |
| 200,000 | 3.855 | 70 |
| 500,000 | 7.27 | 146 |
| 1,000,000 | 12.502 | 274 |
| 5,000,000 | 76.849 | 1300 |
| 10,000,000 | 251.022 | 760 |

### 實驗1 整份讀取+批次寫入
* 每次批次都要清除記憶體
#### 1-1 每10000筆寫入一次
| 筆數 | 秒數(s) | 記憶體用量(mb) |
|------|-----|------------|
| 10,000 | 0.307 | 20 |
| 50,000 | 4.281 | 30 |
| 100,000 | 3.074 | 44 |
| 150,000 | 3.99 | 57 |
| 200,000 | 5.296 | 70 |
| 500,000 | 15.862 | 146 |
| 1,000,000 | 41.27 | 276 |
| 5,000,000 | 649.278 | 1300 |
| 10,000,000 | - | - |
#### 1-2 每50000
| 筆數 | 秒數(s) | 記憶體用量(mb) |
|------|-----|------------|
| 50,000 | 4.281 | 30 |
| 100,000 | 3.083 | 44 |
| 150,000 | 3.85 | 57 |
| 200,000 | 4.228 | 70 |
| 500,000 | 10.328 | 91 |
| 1,000,000 | 19.598 | 275 |
| 5,000,000 | 219.781| 1300 |
| 10,000,000 | - | - |
#### 1-2 每100000
| 筆數 | 秒數(s) | 記憶體用量(mb) |
|------|-----|------------|
| 150,000 | 3.02 | 57 |
| 200,000 | 4.262 | 71 |
| 500,000 | 9.164 | 146 |
| 1,000,000 | 16.53 | 274 |
| 5,000,000 | 133.613 | 809 |
| 10,000,000 | - | - |

### 實驗2 分批讀取 + 批次寫入
#### 2-1 每10000筆一次
| 筆數 | 秒數(s) | 記憶體用量(mb) |
|------|-----|------------|
| 10,000 | 0.429 | 20 |
| 50,000 | 3.335 | 22 |
| 100,000 | 6.042 | 66 ->22 |
| 150,000 | 11.293 | 94 -> 22 |
| 200,000 | 20.228 | 56 |
| 500,000 | 100.443 | 67 |
| 1,000,000 | 385.162 | 530 |
| 5,000,000 | - | - |
| 10,000,000 | - | - |


#### 每50000筆一次
| 筆數 | 秒數(s) | 記憶體用量(mb) |
|------|-----|------------|
| 10,000 |- | - |
| 50,000 | 0.918 | 21 |
| 100,000 | 2.428 | 20 |
| 150,000 | 3.887 | 21 |
| 200,000 | 4.099 | 21 |
| 500,000 | 9.954 | 21 |
| 1,000,000 | 38.197 | 21 |
| 5,000,000 | 520.18 | 21 |
| 10,000,000 | - | - |
#### 每50000筆一次 (GC)
| 筆數 | 秒數(s) | 記憶體用量(mb) |
|------|-----|------------|
| 10,000 |- | - |
| 50,000 | 1.142 | 30 |
| 100,000 | 1.497 | 41 |
| 150,000 | 2.992 | 46 |
| 200,000 | 4.686 | 51 |
| 500,000 | 7.435 | 63 |
| 1,000,000 | 12.957 | 66 |
| 5,000,000 | 158.046 | 65 |
| 10,000,000 | - | - |

#### 每50000筆一次 (固態硬碟＋GC)
| 筆數 | 秒數(s) | 記憶體用量(mb) |
|------|-----|------------|
| 10,000 |- | - |
| 50,000 | 1.235 | 30 |
| 100,000 | 2.294 | 41 |
| 150,000 | 2.968 | 47 |
| 200,000 | 3.632 | 65 |
| 500,000 | 6.999 | 65 |
| 1,000,000 | 12.79 | 65 |
| 5,000,000 | 158.046 | 65 |
| 10,000,000 | - | - |

---
## 新電腦效能紀錄:
#### 循序跑
| 筆數 | 讀取秒數(s)| 寫入秒數(s) |總共耗時秒數(s) | 記憶體用量(mb) |
|------|-----|-----|-----|-----------------|
| 10,000,000 | 44.0 | 126.0 |171.0 |- |

#### 批次跑(100萬)
| 筆數 | 讀取秒數(s)| 寫入秒數(s) |總共耗時秒數(s) | 記憶體用量(mb) |
|------|-----|-----|-----|-----------------|
| 10000000 | 12.183 | 8.519 |21.878|

#### 批次跑(150萬)
| 筆數 | 讀取秒數(s)| 寫入秒數(s) |總共耗時秒數(s) | 記憶體用量(mb) |
|------|-----|-----|-----|-----------------|
| 10000000 | 15.2235 | 4.937 |21.275|
| 10000000 | 11.187 | 12.684 |24.272|
| 10000000 | 12.137 | 14.254 |27.179|

#### 批次跑(200萬)
| 筆數 | 讀取秒數(s)| 寫入秒數(s) |總共耗時秒數(s) | 記憶體用量(mb) |
|------|-----|-----|-----|-----------------|
| 10000000 | 16.931 | 20.573 |38.279|
| 10000000 | 16.533 | 21.972 |40.054|
| 10000000 | 10.808 | 20.604 |32.007|
| 10000000 | 11.55 | 20.328 |32.337|

#### 批次跑(250萬)
| 筆數 | 讀取秒數(s)| 寫入秒數(s) |總共耗時秒數(s) | 記憶體用量(mb) |
|------|-----|-----|-----|-----------------|
| 10000000 | 12.566 | 26.467 |40.063|

#### 批次跑(300萬)
| 筆數 | 讀取秒數(s)| 寫入秒數(s) |總共耗時秒數(s) | 記憶體用量(mb) |
|------|-----|-----|-----|-----------------|
| 10000000 | 12.0235 | 3.8065 |17.492|

#### 批次跑(350萬)
| 筆數 | 讀取秒數(s)| 寫入秒數(s) |總共耗時秒數(s) | 記憶體用量(mb) |
|------|-----|-----|-----|-----------------|
| 10000000 | 17.146 | 40.464 |58.121|

#### 批次跑(400萬)
| 筆數 | 讀取秒數(s)| 寫入秒數(s) |總共耗時秒數(s) | 記憶體用量(mb) |
|------|-----|-----|-----|-----------------|
| 10000000 | 15.008 | 14.748 |30.923|





---

### Split VS Span 效能差異(單純比較單一字串切割，不做任何反射)
| Method | Mean     | Error   | StdDev  | Gen0   | Allocated |
|------- |---------:|--------:|--------:|-------:|----------:|
| Split  | 133.7 ns | 0.73 ns | 0.64 ns | 0.0916 |     481 B |
| Span   | 237.1 ns | 2.16 ns | 2.02 ns | 0.0434 |     228 B |


### Split VS Span 效能差異(比較單一字串切割 + 反射動態產生物件)
| Method | Mean       | Error    | StdDev  | Gen0   | Allocated |
|------- |-----------:|---------:|--------:|-------:|----------:|
| Split  |   893.8 ns |  9.33 ns | 7.79 ns | 0.1507 |     793 B |
| Span   | 1,010.9 ns | 10.54 ns | 9.86 ns | 0.1030 |     541 B |

### Split VS Span 效能差異(比較單一字串切割 + 反射動態產生物件+透過緩存的反射將SetMethod先記錄下來後再呼叫執行)
| Method | Mean     | Error   | StdDev  | Gen0   | Allocated |
|------- |---------:|--------:|--------:|-------:|----------:|
| Split  | 900.8 ns | 7.23 ns | 6.04 ns | 0.1507 |     793 B |
| Span   | 329.6 ns | 3.88 ns | 3.62 ns | 0.0591 |     312 B |

### Split VS Span 效能差異(比較單一字串切割 + 反射動態產生物件+透過緩存的反射將SetMethod先記錄下來後再呼叫執行+同時搜索欄位的值並反射 (不先把資料裝進string[] 再統一做反射))
| Method | Mean     | Error   | StdDev  | Gen0   | Allocated |
|------- |---------:|--------:|--------:|-------:|----------:|
| Split  | 886.8 ns | 2.37 ns | 2.22 ns | 0.1507 |     793 B |
| Span   | 266.8 ns | 0.89 ns | 0.79 ns | 0.0525 |     276 B |


## 結論: 透過分片操作+緩存反射，並且得到字串後馬上進行反射可以將效率最大化，相比原版未經反射前，只增加了50Byte記憶體

---

### 未經優化版本，統一反射+字串拼接+Trim掉最後的,
| Method        | Mean     | Error   | StdDev  | Gen0   | Allocated |
|-------------- |---------:|--------:|--------:|-------:|----------:|
| Write         | 906.6 ns | 2.22 ns | 1.97 ns | 0.1535 |     810 B |
| OptimizeWrite | 899.1 ns | 2.01 ns | 1.78 ns | 0.1535 |     810 B |

### 未經優化版本，統一反射+使用StringBuilder進行字串拼接，最後返回字串,
| Method        | Mean     | Error   | StdDev  | Gen0   | Allocated |
|-------------- |---------:|--------:|--------:|-------:|----------:|
| Write         | 913.6 ns | 2.87 ns | 2.69 ns | 0.1535 |     810 B |
| OptimizeWrite | 703.7 ns | 1.80 ns | 1.68 ns | 0.1259 |     665 B |

### 未經優化版本，統一反射+使用StringBuilder進行字串拼接，最後返回字串,並且個分別Append
| Method        | Mean     | Error   | StdDev  | Gen0   | Allocated |
|-------------- |---------:|--------:|--------:|-------:|----------:|
| Write         | 905.6 ns | 3.01 ns | 2.82 ns | 0.1535 |     810 B |
| OptimizeWrite | 632.0 ns | 4.46 ns | 4.17 ns | 0.0877 |     461 B |

執行300萬次結果
| Method        | Mean    | Error    | StdDev   | Gen0        | Allocated |
|-------------- |--------:|---------:|---------:|------------:|----------:|
| Write         | 2.713 s | 0.0084 s | 0.0075 s | 463000.0000 |   2.26 GB |
| OptimizeWrite | 1.862 s | 0.0045 s | 0.0040 s | 263000.0000 |   1.29 GB |

| Method        | Mean       | Error   | StdDev  | Gen0        | Allocated |
|-------------- |-----------:|--------:|--------:|------------:|----------:|
| Write         | 2,725.6 ms | 8.97 ms | 7.96 ms | 463000.0000 |   2.26 GB |
| OptimizeWrite |   522.1 ms | 1.50 ms | 1.33 ms | 242000.0000 |   1.19 GB |

### 全域　StringBuilder
| Method        | Mean     | Error   | StdDev  | Gen0   | Allocated |
|-------------- |---------:|--------:|--------:|-------:|----------:|
| Write         | 905.0 ns | 6.15 ns | 5.75 ns | 0.1535 |     810 B |
| OptimizeWrite | 117.1 ns | 0.44 ns | 0.41 ns | 0.0305 |     160 B |
### 全域　StringBuilder　＋　９０
| Method        | Mean     | Error   | StdDev  | Gen0   | Allocated |
|-------------- |---------:|--------:|--------:|-------:|----------:|
| Write         | 900.1 ns | 8.40 ns | 7.85 ns | 0.1535 |     810 B |
| OptimizeWrite | 117.4 ns | 0.26 ns | 0.24 ns | 0.0305 |     160 B |
### 非全域 StringBuilder + 用字元串接「,」
| Method        | Mean     | Error   | StdDev  | Gen0   | Allocated |
|-------------- |---------:|--------:|--------:|-------:|----------:|
| Write         | 903.6 ns | 2.81 ns | 2.62 ns | 0.1535 |     810 B |
| OptimizeWrite | 158.9 ns | 0.81 ns | 0.76 ns | 0.0808 |     425 B |
### 全域 StringBuilder + 用字元串接「,」
| Method        | Mean     | Error   | StdDev  | Gen0   | Allocated |
|-------------- |---------:|--------:|--------:|-------:|----------:|
| Write         | 900.1 ns | 8.40 ns | 7.85 ns | 0.1535 |     810 B |
| OptimizeWrite | 117.4 ns | 0.26 ns | 0.24 ns | 0.0305 |     160 B |

### 使用字元陣列
| Method        | Mean     | Error   | StdDev  | Gen0   | Allocated |
|-------------- |---------:|--------:|--------:|-------:|----------:|
| Write         | 893.1 ns | 5.29 ns | 4.13 ns | 0.1535 |     810 B |
| OptimizeWrite | 112.7 ns | 0.17 ns | 0.14 ns | 0.0061 |      32 B |


## 製作 1200 1500 2000 3000 5000 7000 100000000

---

#### 讀取 + 寫入 循序
3000萬 | 28s |
5000萬 | 32024ms
7000萬 |36012ms
1 億 | 41679ms

#### 讀取 + 寫入 六條執行緒(未優化前的紀錄)
| 筆數 | 讀取秒數(s)| 寫入秒數(s) |總共耗時秒數(s) | 記憶體用量(mb) |
|------|-----|-----|-----|-----------------|
| 10000000 | 7.324 | 3.3865 |11.667|
| 20000000 | 11.768 | 3.549 |21.735|
| 30000000 | 11.5815 | 5.421 |34.328|
| 50000000 | 14.261 | 5.419 |59.831|
| 70000000 | 16.463 | 5.38 |86.363|
| 100000000 | 18.802 | 4.23 |131.844|



#### 讀取 + 寫入 六條執行緒(優化後的紀錄)
| 筆數 | 讀取秒數(s)| 寫入秒數(s) |總共耗時秒數(s) | 記憶體用量(mb) |
|------|-----|-----|-----|-----------------|
| 10000000 | 6.9995 | 0.8635 |8.671|
| 20000000 | 9.785 | 1.496 |17.721|
| 30000000 | 12.899 | 1.268 |27.085|
| 50000000 | 14.469 | 1.019 |46.014|
| 70000000 | 16.648 | 0.892 |69.416|
| 100000000 | 19.5175 | 0.565 |116.624|


// cancellation Token => 玩一下這個
// 任務 = 隔一段時間就印一個數字
// 開一個winform 專案(畫面上兩顆按鈕，一顆啟動任務 一顆暫停任務)嘗試使用使用 cancellation token 取消任務 => 如果任務可以成功取消，嘗試看看 讀取一份2000萬的資料 然後嘗試取消他
